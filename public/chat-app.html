<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - Dark Mode</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .glass-effect {
            background: rgba(39, 39, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .chat-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .thinking-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .thinking-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #a78bfa;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .thinking-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .thinking-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        .glow-border {
            border: 1px solid rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
        }
        
        .glow-button {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
        }
        
        .glow-button:hover {
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
        }
        
        .file-upload-area {
            transition: all 0.3s ease;
        }
        
        .file-upload-area:hover {
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(139, 92, 246, 0.05);
        }
        
        .file-preview {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
        }
        
        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: #a78bfa;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        
        .markdown-content code {
            background: rgba(139, 92, 246, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: #c4b5fd;
        }
        
        .markdown-content pre {
            background: rgba(24, 24, 27, 0.8);
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .markdown-content pre code {
            background: transparent;
            padding: 0;
        }
        
        .markdown-content ul,
        .markdown-content ol {
            margin-left: 1.5em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        
        .markdown-content a {
            color: #a78bfa;
            text-decoration: underline;
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(39, 39, 42, 0.5);
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.7);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const BASE_URL = 'http://localhost:3000';

        function ChatApp() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [sessionId, setSessionId] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [uploadedFiles, setUploadedFiles] = useState([]);
            const chatEndRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                initializeSession();
            }, []);

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const scrollToBottom = () => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const initializeSession = async () => {
                try {
                    const response = await fetch(`${BASE_URL}/api/sessions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        mode: 'cors',
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    setSessionId(data.id || data.session_id);
                    console.log('Session initialized:', data.id || data.session_id);
                } catch (error) {
                    console.error('Failed to initialize session:', error);
                    
                    // Check if it's a CORS error
                    if (error.message.includes('CORS') || error.message === 'Failed to fetch') {
                        setMessages([{
                            role: 'assistant',
                            content: '⚠️ **CORS Error Detected**\n\nThe API server needs to allow requests from your browser. Please contact the API administrator to enable CORS or use a CORS proxy.\n\n**Temporary Solution:** You can use a browser extension like "CORS Unblock" or run Chrome with `--disable-web-security` flag for testing.'
                        }]);
                    } else {
                        setMessages([{
                            role: 'assistant',
                            content: `❌ Failed to connect: ${error.message}\n\nPlease check:\n- The API server is running\n- The URL is correct\n- CORS is enabled on the server`
                        }]);
                    }
                    
                    // Set a dummy session ID to allow UI interaction
                    setSessionId('demo-session-id');
                }
            };

            const handleFileSelect = (e) => {
                const files = Array.from(e.target.files);
                
                files.forEach(file => {
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: event.target.result
                        };
                        
                        setUploadedFiles(prev => [...prev, fileData]);
                    };
                    
                    if (file.type.startsWith('image/')) {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                });
            };

            const removeFile = (index) => {
                setUploadedFiles(prev => prev.filter((_, i) => i !== index));
            };

            const sendMessage = async () => {
                if (!input.trim() && uploadedFiles.length === 0) return;
                if (!sessionId) {
                    alert('Session not initialized. Please refresh the page.');
                    return;
                }

                const userMessage = {
                    role: 'user',
                    content: input,
                    files: uploadedFiles.length > 0 ? [...uploadedFiles] : null
                };

                setMessages(prev => [...prev, userMessage]);
                const userInput = input;
                setInput('');
                setUploadedFiles([]);
                setIsLoading(true);

                try {
                    const requestBody = {
                        app_name: 'app',
                        user_id: 'web-user-01',
                        session_id: sessionId,
                        new_message: {
                            parts: [{ text: userInput }]
                        }
                    };

                    console.log('Sending request:', requestBody);

                    const response = await fetch(`${BASE_URL}/api/run`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Received response:', data);
                    
                    // Extract the last text message from events
                    let botResponse = 'No response received.';
                    
                    // Handle both array response and object with events property
                    const events = Array.isArray(data) ? data : (data.events || []);
                    
                    if (Array.isArray(events) && events.length > 0) {
                        for (let i = events.length - 1; i >= 0; i--) {
                            const event = events[i];
                            if (event.content && event.content.parts) {
                                for (const part of event.content.parts) {
                                    if (part.text) {
                                        botResponse = part.text;
                                        break;
                                    }
                                }
                                if (botResponse !== 'No response received.') break;
                            }
                            if (event.message && event.message.parts) {
                                for (const part of event.message.parts) {
                                    if (part.text) {
                                        botResponse = part.text;
                                        break;
                                    }
                                }
                                if (botResponse !== 'No response received.') break;
                            }
                        }
                    }

                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: botResponse
                    }]);
                } catch (error) {
                    console.error('Error sending message:', error);
                    
                    let errorMessage = '❌ Failed to send message. ';
                    
                    if (error.message.includes('CORS') || error.message === 'Failed to fetch') {
                        errorMessage += '\n\n**CORS Issue:** The server is blocking requests from your browser.\n\n**Solutions:**\n1. Use a CORS proxy\n2. Enable CORS on the API server\n3. Use a browser extension like "CORS Unblock"\n4. Run the API locally with CORS enabled';
                    } else if (error.message.includes('NetworkError')) {
                        errorMessage += '\n\n**Network Error:** Cannot reach the server. Please check your internet connection and verify the API URL.';
                    } else {
                        errorMessage += `\n\nError: ${error.message}`;
                    }
                    
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: errorMessage
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            };

            const resetSession = async () => {
                setMessages([]);
                setUploadedFiles([]);
                setInput('');
                await initializeSession();
            };

            const renderMarkdown = (text) => {
                const html = marked.parse(text);
                return <div className="markdown-content" dangerouslySetInnerHTML={{ __html: html }} />;
            };

            return (
                <div className="h-screen bg-zinc-900 flex flex-col">
                    {/* Header */}
                    <div className="glass-effect px-6 py-4 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-black/40 border border-zinc-700 flex items-center justify-center">
                                {/* Gemini icon (simple star) */}
                                <svg className="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2l1.9 4.85L19 8l-3.05 2.05L15 15l-3-2-3 2 1.05-4.95L5 8l5.1-1.15L12 2z" fill="#F8FAFC" />
                                </svg>
                            </div>
                            <div>
                                <h1 className="text-lg font-bold text-white">Gemini</h1>
                                <p className="text-sm text-zinc-300">Hi Magudesh — I am your AI assistant for Magudesh</p>
                                <p className="text-xs text-zinc-400">{sessionId ? 'Connected' : 'Connecting...'}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button
                                onClick={resetSession}
                                className="px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg text-sm font-medium transition-all glow-button"
                            >
                                Reset Session
                            </button>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 overflow-y-auto px-4 py-6 space-y-4 scrollbar-thin">
                        {messages.length === 0 && (
                            <div className="flex items-center justify-center h-full">
                                <div className="w-full max-w-4xl px-6 py-12 md:py-20 lg:py-28">
                                    <div className="bg-zinc-900/60 backdrop-blur-md border border-zinc-800 rounded-2xl p-8 md:p-12">
                                        <div className="md:flex md:items-center md:justify-between">
                                            <div className="md:flex-1 md:pr-6 text-center md:text-left">
                                                <p className="text-sm text-zinc-400 mb-3">Hi Magudesh</p>
                                                <h1 className="text-3xl md:text-5xl font-extrabold text-white leading-tight mb-4">Where should we start?</h1>
                                                <p className="text-zinc-400 max-w-2xl">Ask Gemini anything — quick answers, create images, write code, or get summaries. The assistant is ready to help.</p>
                                            </div>
                                            <div className="mt-6 md:mt-0 md:w-1/2">
                                                <div className="flex items-center gap-3 bg-zinc-800 rounded-full px-4 py-3">
                                                    <input
                                                        className="flex-1 bg-transparent outline-none text-white placeholder:text-zinc-400"
                                                        placeholder="Ask Gemini 3"
                                                        onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } }}
                                                        value={input}
                                                        onChange={(e) => setInput(e.target.value)}
                                                    />
                                                    <button onClick={sendMessage} className="bg-violet-600 hover:bg-violet-700 text-white rounded-full px-4 py-2">Ask</button>
                                                </div>
                                                <div className="mt-4 flex flex-wrap gap-2">
                                                    <button className="px-3 py-1 bg-zinc-800 rounded-lg text-sm text-zinc-300">Create image</button>
                                                    <button className="px-3 py-1 bg-zinc-800 rounded-lg text-sm text-zinc-300">Write anything</button>
                                                    <button className="px-3 py-1 bg-zinc-800 rounded-lg text-sm text-zinc-300">Help me learn</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {messages.map((msg, index) => (
                            <div key={index} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`chat-bubble max-w-3xl ${
                                    msg.role === 'user' 
                                        ? 'bg-violet-600 text-white rounded-3xl rounded-br-md' 
                                        : 'bg-zinc-800 text-zinc-100 rounded-3xl rounded-bl-md glow-border'
                                } px-6 py-4`}>
                                    {msg.files && msg.files.length > 0 && (
                                        <div className="mb-3 space-y-2">
                                            {msg.files.map((file, idx) => (
                                                <div key={idx} className="bg-zinc-700/50 rounded-lg p-2">
                                                    {file.type.startsWith('image/') ? (
                                                        <img src={file.data} alt={file.name} className="file-preview rounded" />
                                                    ) : (
                                                        <div className="flex items-center gap-2 text-sm">
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                            </svg>
                                                            <span>{file.name}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {msg.role === 'assistant' ? renderMarkdown(msg.content) : <p className="whitespace-pre-wrap">{msg.content}</p>}
                                </div>
                            </div>
                        ))}

                        {isLoading && (
                            <div className="flex justify-start">
                                <div className="chat-bubble bg-zinc-800 text-zinc-100 rounded-3xl rounded-bl-md px-6 py-4 glow-border">
                                    <div className="flex items-center gap-3">
                                        <span className="text-zinc-400">Thinking</span>
                                        <div className="thinking-dots">
                                            <span></span>
                                            <span></span>
                                            <span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div ref={chatEndRef} />
                    </div>

                    {/* Input Area */}
                    <div className="px-4 py-4 bg-zinc-900 border-t border-zinc-800">
                        {uploadedFiles.length > 0 && (
                            <div className="mb-3 flex flex-wrap gap-2">
                                {uploadedFiles.map((file, index) => (
                                    <div key={index} className="relative bg-zinc-800 rounded-lg p-2 pr-8 border border-zinc-700">
                                        {file.type.startsWith('image/') ? (
                                            <img src={file.data} alt={file.name} className="h-16 w-16 object-cover rounded" />
                                        ) : (
                                            <div className="flex items-center gap-2 px-2">
                                                <svg className="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                                <span className="text-sm text-zinc-300">{file.name}</span>
                                            </div>
                                        )}
                                        <button
                                            onClick={() => removeFile(index)}
                                            className="absolute top-1 right-1 bg-red-500 hover:bg-red-600 rounded-full p-1"
                                        >
                                            <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                ))}
                            </div>
                        )}

                        <div className="max-w-4xl mx-auto flex items-end gap-3">
                            <input
                                type="file"
                                ref={fileInputRef}
                                onChange={handleFileSelect}
                                multiple
                                className="hidden"
                                accept="image/*,.txt,.pdf,.doc,.docx"
                            />
                            
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                className="p-3 bg-zinc-800 hover:bg-zinc-700 text-violet-400 rounded-full transition-all border border-zinc-700 hover:border-violet-500"
                                title="Upload file"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                </svg>
                            </button>

                            <textarea
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="Type your message..."
                                className="flex-1 bg-zinc-800 text-white rounded-2xl px-5 py-3 resize-none focus:outline-none focus:ring-2 focus:ring-violet-500 border border-zinc-700 scrollbar-thin"
                                rows="1"
                                style={{ minHeight: '50px', maxHeight: '150px' }}
                            />

                            <button
                                onClick={sendMessage}
                                disabled={isLoading || (!input.trim() && uploadedFiles.length === 0)}
                                className="p-3 bg-violet-600 hover:bg-violet-700 disabled:bg-zinc-700 disabled:cursor-not-allowed text-white rounded-full transition-all glow-button"
                            >
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<ChatApp />, document.getElementById('root'));
    </script>
</body>
</html>